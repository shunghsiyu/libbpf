#!/bin/bash

# This file is sourced by libbpf/ci/run-vmtest Github Action scripts.

# $SELFTESTS_BPF and $VMTEST_CONFIGS are set in the workflow, before
# libbpf/ci/run-vmtest action is called
# See .github/workflows/kernel-test.yml

ALLOWLIST_FILES=(
    "${SELFTESTS_BPF}/ALLOWLIST"
    "${SELFTESTS_BPF}/ALLOWLIST.${ARCH}"
    "${VMTEST_CONFIGS}/ALLOWLIST"
    "${VMTEST_CONFIGS}/ALLOWLIST-${KERNEL}"
    "${VMTEST_CONFIGS}/ALLOWLIST-${KERNEL}.${ARCH}"
)

# DEBUG: Print allowlist configuration
echo "=========================================="
echo "DEBUG: Allowlist Configuration"
echo "=========================================="
echo "Allowlist files being checked:"
for file in "${ALLOWLIST_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  [EXISTS] $file"
    else
        echo "  [MISSING] $file"
    fi
done
echo "=========================================="

DENYLIST_FILES=(
    "${SELFTESTS_BPF}/DENYLIST"
    "${SELFTESTS_BPF}/DENYLIST.${ARCH}"
    "${VMTEST_CONFIGS}/DENYLIST"
    "${VMTEST_CONFIGS}/DENYLIST-${KERNEL}"
    "${VMTEST_CONFIGS}/DENYLIST-${KERNEL}.${ARCH}"
)

# DEBUG: Print denylist configuration
echo "=========================================="
echo "DEBUG: Denylist Configuration"
echo "=========================================="
echo "KERNEL variable: '${KERNEL}'"
echo "ARCH variable: '${ARCH}'"
echo "VMTEST_CONFIGS: '${VMTEST_CONFIGS}'"
echo ""
echo "All DENYLIST* files in VMTEST_CONFIGS directory:"
ls -la "${VMTEST_CONFIGS}"/DENYLIST* 2>/dev/null || echo "  (none found)"
echo ""
echo "Denylist files being checked:"
for file in "${DENYLIST_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  [EXISTS] $file"
        echo "    Contents:"
        cat "$file" | sed 's/^/      /'
    else
        echo "  [MISSING] $file"
    fi
done
echo "=========================================="

# Export pipe-separated strings, because bash doesn't support array export
export SELFTESTS_BPF_ALLOWLIST_FILES=$(IFS="|"; echo "${ALLOWLIST_FILES[*]}")
export SELFTESTS_BPF_DENYLIST_FILES=$(IFS="|"; echo "${DENYLIST_FILES[*]}")

echo "=========================================="
echo "DEBUG: Exported Variables"
echo "=========================================="
echo "SELFTESTS_BPF_DENYLIST_FILES:"
echo "$SELFTESTS_BPF_DENYLIST_FILES" | tr '|' '\n' | sed 's/^/  /'
echo "=========================================="

if [[ "${LLVM_VERSION}" -lt 18 ]]; then
    echo "KERNEL_TEST=test_progs test_progs_no_alu32 test_maps test_verifier" >> $GITHUB_ENV
else # all
    echo "KERNEL_TEST=test_progs test_progs_cpuv4 test_progs_no_alu32 test_maps test_verifier" >> $GITHUB_ENV
fi

echo "cp -R ${SELFTESTS_BPF} ${GITHUB_WORKSPACE}/selftests"
mkdir -p "${GITHUB_WORKSPACE}/selftests"
cp -R "${SELFTESTS_BPF}" "${GITHUB_WORKSPACE}/selftests"
